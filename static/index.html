<!DOCTYPE html>
<html>
<!--
  Copyright (c) 2020 Jérôme Martin <rilouw.eu>
  The code for this project is released under the terms of the GNU AGPLv3.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<head>
  <meta charset="utf-8">
  <title>Racket Poetry by euhmeuh</title>
  <link rel="stylesheet" type="text/css" href="rilouwshell.css">
  <style type="text/css">
    :root {
      --bg: #ECE1D6;
      --fg: #DFC9B2;
      --accent: #3e3329;
      --high: #80634c;
    }

    html {
      height: 100%;
      display: flex;
      align-items: stretch;
      flex-direction: column;
    }

    body {
      flex: 1;
      display: flex;
      max-width: 100%;
      margin: 0;
      flex-direction: column;
      flex-wrap: wrap;
      align-items: stretch;
    }

    @media (orientation: landscape) {
      body {
        flex-direction: row;
      }
    }

    #editor, #emulator, #dictionary {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin: 12px;
    }

    #editor textarea {
      flex: 1;
      font-size: 2em;
      height: 100%;
      resize: none;
      font-family: serif;
    }

    #emulator #canvas-holder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #emulator canvas {
      border: 1px solid var(--bg);
    }

    #dictionary .content {
      flex: 1 1 auto;
      overflow-y: auto;
      height: 0;
      min-height: 512px;
      padding-right: 12px;
    }

    summary {
      font-size: 1.5em;
      padding: 12px;
      border: 1px solid var(--bg);
      border-radius: var(--border-radius);
    }

    details {
      margin-bottom: 6px;
    }

    details p {
      margin-left: 24px;
    }

    dt {
      font-weight: bold;
      margin-left: 24px;
      margin-top: 24px;
      margin-bottom: 12px;
    }

    dd {
      margin-left: 48px;
    }

    .arg {
      background-color: var(--bg);
      color: var(--accent);
      font-weight: normal;
      border-radius: 64px;
      padding: 4px 8px 0px 8px;
    }

    .arg.opt {
      background-color: transparent;
      border: 1px solid var(--bg);
      color: var(--bg);
    }
  </style>
</head>
<body>
  <section id="editor">
    <h1>Racket Poetry</h1>
    <p class="box secondary">
      Write some poems and see the result by clicking "Read!".<br>
      <br>
      <small>Made with <a href="https://racket-lang.org">Racket</a> by <a href="https://github.com/euhmeuh/racket-poetry">Jérôme Martin</a></small>
      <small>//</small>
      <small>Chip-8 Emulator by <a href="https://github.com/alexanderdickson/Chip-8-Emulator">Alexander Dickson</a></small>
    </p>
    <textarea>
- Hello world -
You painted the emptiness, once again with life.
Adding voids with that painting stick.
You always skip snowy grounds, that's true.
But since the night isn't close yet, I'll take it.
Go and say: Hello, world!
</textarea>
    <div class="button-box">
      <a class="button secondary pull-left" href="https://github.com/euhmeuh/racket-poetry" target="_blank">GitHub</a>
      <button type="button" class="secondary">Help</button>
      <button id="button-dictionary" type="button" class="secondary">Dictionary</button>
      <button id="button-read" type="button" class="primary">Read!</button>
    </div>
  </section>

  <section id="emulator" class="box primary">
    <div id="canvas-holder">
      <canvas></canvas>
    </div>
    <div id="messages"></div>
  </section>

  <section id="dictionary" class="box primary display-none">
    <h2>Dictionary</h2>
    <div class="content">
      <details>
        <summary>Numbers</summary>
        <p>
           Numbers are expressed as hexadecimal nibbles, from 0 to F.<br>
           For example, the number 42 is 2A in hexadecimal, which is made of the nibbles 2 and A.<br>
           2 can be "Fire" and A can be "Spark", so 42 can be expressed as "Fire spark".<br>
           Other possibilities are "Red thunder", "Blazing bolt" or "Smell twice the Violet".
        </p>
        <dl>
          <dt>0 (zero)</dt>
          <dd>Void, Death, Night, Blackhole, Zero, None, Empty(iness), Nothing(ness), Still(ness), Snow, Nowhere, False, Dark, Black</dd>
          <dt>1 (one)</dt>
          <dd>Water, Tear, Sea, Yes, True, Truth, Everywhere, One, Once, First, Blue</dd>
          <dt>2 (two)</dt>
          <dd>Fire, Blaze, Burn, Two, Twice, Second(ary), Red</dd>
          <dt>3 (three)</dt>
          <dd>Vapor, Steam, Fog, Three, Third, Purple</dd>
          <dt>4 (four)</dt>
          <dd>Earth, Soil, Ground, Rocks, Four(th), Yellow</dd>
          <dt>5 (five)</dt>
          <dd>Mud, Oil, Glue, Tree, Leaf, Five, Fifth, Green</dd>
          <dt>6 (six)</dt>
          <dd>Lava, Volcano, Six(th), Orange</dd>
          <dt>7 (seven)</dt>
          <dd>Ceramic, Bowl, Seven(th), Grey, Gray</dd>
          <dt>8 (eight)</dt>
          <dd>Wind, Blow, Eight(h), Cyan</dd>
          <dt>9 (nine)</dt>
          <dd>Rain, Drop, Nine, Ninth, Marine</dd>
          <dt>A (ten)</dt>
          <dd>Thunder, Bolt, Spark, Ten(th), Violet</dd>
          <dt>B (eleven)</dt>
          <dd>Cloud, Sky, Eleven(th), Pink</dd>
          <dt>C (twelve)</dt>
          <dd>Sand, Desert, Snake, Twelve, Twelfth, Rose</dd>
          <dt>D (thirteen)</dt>
          <dd>River, Net, Fish, Thirteen(th), Azure(an)</dd>
          <dt>E (fourteen)</dt>
          <dd>Window, Glass, Transparent, Fourteen(th)</dd>
          <dt>F (fifteen)</dt>
          <dd>Life, Living, Complete, Full(y), Sun, Light, Planet, Fifteen(th), White</dd>
        </dl>
      </details>
      <details>
        <summary>Verbs</summary>
        <p>
          Verbs expect some parameters to be present anywhere inside the sentence (even before them). The order of the parameters is important, because the verb will take them from first to last.<br>
          In definitions, the number of parameters each verb takes is indicated just after the verb, like this:
        <blockquote>
          <dl>
            <dt>Verb <span class="arg">X</span> <span class="arg">Y</span></dt>
            <dd>What the verb does with <span class="arg">X</span> and <span class="arg">Y</span>.</dd>
          </dl>
        </blockquote>
        <p>
          There are three types of parameters : numbers, indexes and modifiers.
        </p>
        <p>
          Numbers are nibbles (see the "Numbers" section of the dictionary) and can sometimes be expressed by specifying the last nibble only (the first being an implicit zero). In that case, the implicit argument is indicated with a circle <span class="arg opt">A</span> in the verb definition.
        </p>
        <p>
          Indexes are used for movements and memory instructions. The verb tries to find the longest complete word in the sentence that matches one of the poem titles. Indexes cannot be expressed as numbers for now, only as plain text words.
        </p>
        <p>
          Modifiers are used in only two verbs, "Skip, Evade" and "Jump". They specify whether the instruction should be "skip if equal" or "skip if different". They can be anywhere in the sentence, but need to be there, otherwise the verb can't be translated into a machine instruction. You can find the list of modifiers in the corresponding dictionary section.
        </p>
        <dl>
          <dt>Quit <span class="arg">A</span></dt>
          <dd>Stop the program and return the value <span class="arg">A</span>.</dd>
        </dl>
        <dl>
          <dt>Clear</dt>
          <dd>Clear the screen.</dd>
        </dl>
        <dl>
          <dt>Return, Leave</dt>
          <dd>Return from a subroutine.</dd>
        </dl>
        <dl>
          <dt>Go <span class="arg">Index</span></dt>
          <dd>Go to the given title.</dd>
        </dl>
        <dl>
          <dt>Call, Hail <span class="arg">Index</span></dt>
          <dd>Call the subroutine at the given title.</dd>
        </dl>
        <dl>
          <dt>Skip, Evade <span class="arg">X</span> <span class="arg opt">A</span> <span class="arg">B</span> (needs a modifier)</dt>
          <dd>Skip the next instruction unless the register <span class="arg">X</span> is equal/unequal to the number <span class="arg">AB</span> (when ommited, A is zero).</dd>
        </dl>
        <dl>
          <dt>Jump <span class="arg">X</span> <span class="arg">Y</span> (needs a modifier)</dt>
          <dd>Jump over the next instruction unless the register <span class="arg">X</span> is equal/unequal to the register <span class="arg">Y</span>.</dd>
        </dl>
      </details>
      <details>
        <summary>Modifiers</summary>
        <dl>
          <dt></dt>
          <dd></dd>
        </dl>
      </details>
    </div>
  </section>

  <script type="text/javascript" src="_.js"></script>
  <script type="text/javascript" src="page.js"></script>
  <script type="text/javascript" src="request.js"></script>
  <script type="text/javascript" src="rilouwshell.js"></script>
  <script type="text/javascript" src="base64.js"></script>
  <script type="text/javascript" src="chip8.js"></script>
  <script type="text/javascript" src="renderer.js"></script>
  <script type="text/javascript">
    Page.onload(() => {
      RilouwShell.init();

      function clearMessages() {
        Page.get('#messages').innerHTML = "";
      }

      function addMessage(text) {
        Page.get('#messages').appendChild(
          Page.createElementFromJson({
            tag: "p", text
          })
        );
      }

      const textarea = Page.get('textarea');
      Page.get('#button-read').addEventListener('click', () => {
        clearMessages();
        chip.reset();
        addMessage("Reading your poem...");
        Request.post("/", textarea.value, "text/plain").then((response) => {
          clearMessages();
          console.log(response);
          const program = Base64.decode(response.binary);
          chip.loadProgram(program);
          chip.start();
        });
      });

      Page.get('#button-dictionary').addEventListener('click', () => {
        const dict = Page.get('#dictionary');
        const emulator = Page.get('#emulator');
        if(dict.classList.contains('display-none')) {
          dict.classList.remove('display-none');
          emulator.classList.add('display-none');
        } else {
          dict.classList.add('display-none');
          emulator.classList.remove('display-none');
        }
      });

      const PIXEL_SIZE = 12;
      const canvas = document.querySelector("canvas");
      const chip = new Chip8;
      const chipRenderer = new CanvasRenderer(
        canvas,
        chip.getDisplayWidth(),
        chip.getDisplayHeight(),
        PIXEL_SIZE
      );
      chipRenderer.setFgColor("#ECE1D6");
      chip.setRenderer(chipRenderer);
      chip.setCycles(40);
      //chip.setCycles(28672);

      const translateKeys = {
        49: 0x1,  // 1
        50: 0x2,  // 2
        51: 0x3,  // 3
        52: 0x4,  // 4
        81: 0x5,  // Q
        87: 0x6,  // W
        69: 0x7,  // E
        82: 0x8,  // R
        65: 0x9,  // A
        83: 0xA,  // S
        68: 0xB,  // D
        70: 0xC,  // F
        90: 0xD,  // Z
        88: 0xE,  // X
        67: 0xF,  // C
        86: 0x10  // V
      };

      document.addEventListener("keydown", function(event) {
        chip.setKey(translateKeys[event.keyCode]);
      });

      document.addEventListener("keyup", function(event) {
        chip.unsetKey(translateKeys[event.keyCode]);
      });
    });
  </script>
</body>
</html>
