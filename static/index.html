<!DOCTYPE html>
<html>
<!--
  Copyright (c) 2020 Jérôme Martin <rilouw.eu>
  The code for this project is released under the terms of the GNU AGPLv3.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<head>
  <meta charset="utf-8">
  <title>Racket Poetry by euhmeuh</title>
  <link rel="stylesheet" type="text/css" href="rilouwshell.css">
  <style type="text/css">
    :root {
      --bg: #ECE1D6;
      --fg: #DFC9B2;
      --accent: #3e3329;
      --high: #80634c;
    }

    html {
      height: 100%;
      display: flex;
      align-items: stretch;
      flex-direction: column;
    }

    body {
      flex: 1;
      display: flex;
      max-width: 100%;
      margin: 0;
      flex-direction: column;
      flex-wrap: wrap;
      align-items: stretch;
    }

    @media (orientation: landscape) {
      body {
        flex-direction: row;
      }
    }

    #editor, #emulator, #dictionary {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin: 12px;
    }

    #editor textarea {
      flex: 1;
      font-size: 2em;
      height: 100%;
      resize: none;
      font-family: serif;
    }

    #emulator #canvas-holder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #emulator canvas {
      border: 1px solid var(--bg);
    }
  </style>
</head>
<body>
  <section id="editor">
    <h1>Racket Poetry</h1>
    <p class="box secondary">
      Write some poems and see the result by clicking "Read!".<br>
      <br>
      <small>Made with <a href="https://racket-lang.org">Racket</a> by <a href="https://github.com/euhmeuh/racket-poetry">Jérôme Martin</a></small>
      <small>//</small>
      <small>Chip-8 Emulator by <a href="https://github.com/alexanderdickson/Chip-8-Emulator">Alexander Dickson</a></small>
    </p>
    <textarea>
- Hello world -
You painted the emptiness, once again with life.
Adding voids with that painting stick.
You always skip snowy grounds, that's true.
But since the night isn't close yet, I'll take it.
Go and say: Hello, world!
</textarea>
    <div class="button-box">
      <a class="button secondary pull-left" href="https://github.com/euhmeuh/racket-poetry" target="_blank">GitHub</a>
      <button type="button" class="secondary">Help</button>
      <button id="button-dictionary" type="button" class="secondary">Dictionary</button>
      <button id="button-read" type="button" class="primary">Read!</button>
    </div>
  </section>

  <section id="emulator" class="box primary">
    <div id="canvas-holder">
      <canvas></canvas>
    </div>
    <div id="messages"></div>
  </section>

  <section id="dictionary" class="box primary display-none">
    <h2>Dictionary</h2>
    <details>
      <summary>Numbers</summary>
      <p>Numbers are expressed as hexadecimal nibbles, from 0 to F.<br>
         For example, the number 42 is 2A in hexadecimal, which is made of the nibbles 2 and A.</p>
      <dl>
        <dt>0 (zero)</dt>
        <dd>Void, Death, Night, Blackhole, Zero, None, Empty(iness), Nothing(ness), Still(ness), Snow, Nowhere, False, Dark, Black</dd>
        <dt>1 (one)</dt>
        <dd>Water, Tear, Sea, Yes, True, Truth, Everywhere, One, Once, First, Blue</dd>
        <dt>2 (two)</dt>
        <dd>Fire, Blaze, Burn, Two, Twice, Second(ary), Red</dd>
        <dt>3 (three)</dt>
        <dd>Vapor, Steam, Fog, Three, Third, Purple</dd>
        <dt>4 (four)</dt>
        <dd>Earth, Soil, Ground, Rocks, Four, Fourth, Yellow</dd>
        <dt>5 (five)</dt>
        <dd>Mud, Oil, Glue, Tree, Leaf, Five, Fifth, Green</dd>
        <dt>6 (six)</dt>
        <dd>Lava, Volcano, Six, Sixth, Orange</dd>
        <dt>7 (seven)</dt>
        <dd>Ceramic, Bowl, Seven, Seventh, Grey, Gray</dd>
        <dt>8 (eight)</dt>
        <dd>Wind, Blow, Eight, Cyan</dd>
        <dt>9 (nine)</dt>
        <dd>Rain, Drop, Nine, Ninth, Marine</dd>
        <dt>A (ten)</dt>
        <dd>Thunder, Bolt, Spark, Ten, Tenth, Violet</dd>
        <dt>B (eleven)</dt>
        <dd>Cloud, Sky, Eleven, Eleventh, Pink</dd>
        <dt>C (twelve)</dt>
        <dd>Sand, Desert, Snake, Twelve, Twelfth, Rose</dd>
        <dt>D (thirteen)</dt>
        <dd>River, Net, Fish, Thirteen, Thirteenth, Azure(an)</dd>
        <dt>E (fourteen)</dt>
        <dd>Window, Glass, Transparent, Fourteen, Fourteenth</dd>
        <dt>F (fifteen)</dt>
        <dd>Life, Living, Complete, Full(y), Sun, Light, Planet, Fifteen, Fifteenth, White</dd>
      </dl>
    </details>
    <details>
      <summary>Verbs</summary>
      <dl>
        <dt></dt>
        <dd></dd>
      </dl>
    </details>
    <details>
      <summary>Modifiers</summary>
      <dl>
        <dt></dt>
        <dd></dd>
      </dl>
    </details>
  </section>

  <script type="text/javascript" src="_.js"></script>
  <script type="text/javascript" src="page.js"></script>
  <script type="text/javascript" src="request.js"></script>
  <script type="text/javascript" src="rilouwshell.js"></script>
  <script type="text/javascript" src="base64.js"></script>
  <script type="text/javascript" src="chip8.js"></script>
  <script type="text/javascript" src="renderer.js"></script>
  <script type="text/javascript">
    Page.onload(() => {
      RilouwShell.init();

      function clearMessages() {
        Page.get('#messages').innerHTML = "";
      }

      function addMessage(text) {
        Page.get('#messages').appendChild(
          Page.createElementFromJson({
            tag: "p", text
          })
        );
      }

      const textarea = Page.get('textarea');
      Page.get('#button-read').addEventListener('click', () => {
        clearMessages();
        chip.reset();
        addMessage("Reading your poem...");
        Request.post("/", textarea.value, "text/plain").then((response) => {
          clearMessages();
          console.log(response);
          const program = Base64.decode(response.binary);
          chip.loadProgram(program);
          chip.start();
        });
      });

      Page.get('#button-dictionary').addEventListener('click', () => {
        const dict = Page.get('#dictionary');
        const emulator = Page.get('#emulator');
        if(dict.classList.contains('display-none')) {
          dict.classList.remove('display-none');
          emulator.classList.add('display-none');
        } else {
          dict.classList.add('display-none');
          emulator.classList.remove('display-none');
        }
      });

      const PIXEL_SIZE = 12;
      const canvas = document.querySelector("canvas");
      const chip = new Chip8;
      const chipRenderer = new CanvasRenderer(
        canvas,
        chip.getDisplayWidth(),
        chip.getDisplayHeight(),
        PIXEL_SIZE
      );
      chipRenderer.setFgColor("#ECE1D6");
      chip.setRenderer(chipRenderer);
      chip.setCycles(40);
      //chip.setCycles(28672);

      const translateKeys = {
        49: 0x1,  // 1
        50: 0x2,  // 2
        51: 0x3,  // 3
        52: 0x4,  // 4
        81: 0x5,  // Q
        87: 0x6,  // W
        69: 0x7,  // E
        82: 0x8,  // R
        65: 0x9,  // A
        83: 0xA,  // S
        68: 0xB,  // D
        70: 0xC,  // F
        90: 0xD,  // Z
        88: 0xE,  // X
        67: 0xF,  // C
        86: 0x10  // V
      };

      document.addEventListener("keydown", function(event) {
        chip.setKey(translateKeys[event.keyCode]);
      });

      document.addEventListener("keyup", function(event) {
        chip.unsetKey(translateKeys[event.keyCode]);
      });
    });
  </script>
</body>
</html>
