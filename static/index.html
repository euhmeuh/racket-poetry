<!DOCTYPE html>
<html>
<!--
  Copyright (c) 2020 Jérôme Martin <rilouw.eu>
  The code for this project is released under the terms of the GNU AGPLv3.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
<head>
  <meta charset="utf-8">
  <title>Racket Poetry by euhmeuh</title>
  <link rel="stylesheet" type="text/css" href="rilouwshell.css">
  <style type="text/css">
    :root {
      --bg: #ECE1D6;
      --fg: #DFC9B2;
      --accent: #3e3329;
      --high: #80634c;
    }

    html {
      height: 100%;
      display: flex;
      align-items: stretch;
      flex-direction: column;
    }

    body {
      flex: 1;
      display: flex;
      max-width: 100%;
      margin: 0;
      flex-direction: column;
      flex-wrap: wrap;
      align-items: stretch;
    }

    @media (orientation: landscape) {
      body {
        flex-direction: row;
      }
    }

    #editor, #emulator {
      display: flex;
      flex-direction: column;
      flex: 1;
      margin: 12px;
    }

    #editor textarea {
      flex: 1;
      font-size: 2em;
      height: 100%;
      resize: none;
      font-family: serif;
    }

    #emulator #canvas-holder {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #emulator canvas {
      border: 1px solid var(--bg);
    }
  </style>
</head>
<body>
  <section id="editor">
    <h1>Racket Poetry</h1>
    <p class="box secondary">
      Write some poems and see the result by clicking "Read!".<br>
      <br>
      <small>Made with <a href="https://racket-lang.org">Racket</a> by <a href="https://github.com/euhmeuh/racket-poetry">Jérôme Martin</a></small>
      <small>//</small>
      <small>Chip-8 Emulator by <a href="https://github.com/alexanderdickson/Chip-8-Emulator">Alexander Dickson</a></small>
    </p>
    <textarea></textarea>
    <div class="button-box">
      <button type="button" class="secondary pull-left">GitHub</button>
      <button type="button" class="secondary">Help</button>
      <button id="button-dictionary" type="button" class="secondary">Dictionary</button>
      <button id="button-read" type="button" class="primary">Read!</button>
    </div>
  </section>

  <section id="emulator" class="box primary">
    <div id="canvas-holder">
      <canvas></canvas>
    </div>
    <div id="messages"></div>
  </section>

  <script type="text/javascript" src="_.js"></script>
  <script type="text/javascript" src="page.js"></script>
  <script type="text/javascript" src="request.js"></script>
  <script type="text/javascript" src="rilouwshell.js"></script>
  <script type="text/javascript" src="base64.js"></script>
  <script type="text/javascript" src="chip8.js"></script>
  <script type="text/javascript" src="renderer.js"></script>
  <script type="text/javascript">
    Page.onload(() => {
      RilouwShell.init();

      function clearMessages() {
        Page.get('#messages').innerHTML = "";
      }

      function addMessage(text) {
        Page.get('#messages').appendChild(
          Page.createElementFromJson({
            tag: "p", text
          })
        );
      }

      const textarea = Page.get('textarea');
      Page.get('#button-read').addEventListener('click', () => {
        clearMessages();
        chip.reset();
        addMessage("Reading your poem...");
        Request.post("/", textarea.value, "text/plain").then((response) => {
          clearMessages();
          console.log(response);
          const program = Base64.decode(response.binary);
          chip.loadProgram(program);
          chip.start();
        });
      });

      Page.get('#button-dictionary').addEventListener('click', () => {
        // TODO
      });

      const PIXEL_SIZE = 12;
      const canvas = document.querySelector("canvas");
      const chip = new Chip8;
      const chipRenderer = new CanvasRenderer(
        canvas,
        chip.getDisplayWidth(),
        chip.getDisplayHeight(),
        PIXEL_SIZE
      );
      chipRenderer.setFgColor("#ECE1D6");
      chip.setRenderer(chipRenderer);
      chip.setCycles(40);
      //chip.setCycles(28672);

      const translateKeys = {
        49: 0x1,  // 1
        50: 0x2,  // 2
        51: 0x3,  // 3
        52: 0x4,  // 4
        81: 0x5,  // Q
        87: 0x6,  // W
        69: 0x7,  // E
        82: 0x8,  // R
        65: 0x9,  // A
        83: 0xA,  // S
        68: 0xB,  // D
        70: 0xC,  // F
        90: 0xD,  // Z
        88: 0xE,  // X
        67: 0xF,  // C
        86: 0x10  // V
      };

      document.addEventListener("keydown", function(event) {
        chip.setKey(translateKeys[event.keyCode]);
      });

      document.addEventListener("keyup", function(event) {
        chip.unsetKey(translateKeys[event.keyCode]);
      });
    });
  </script>
</body>
</html>
